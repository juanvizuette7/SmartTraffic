<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SmartTraffic Monitor</title>
  <style>
    :root { --bg:#0b1222; --panel:#161f35; --text:#e5edff; --muted:#9aa5c4; --ok:#34d399; --warn:#fbbf24; --alert:#f87171; }
    *{box-sizing:border-box;font-family:"Segoe UI",Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text);display:flex;justify-content:center;padding:32px}
    main{width:min(940px,100%);display:grid;gap:18px}
    header,section,.card{background:var(--panel);border-radius:16px;padding:20px;border:1px solid rgba(148,163,184,.2)}
    header{text-align:center}
    h1{margin:0;font-size:1.85rem}
    p{margin:6px 0 0;color:var(--muted)}
    .status{margin-top:12px;display:inline-flex;align-items:center;gap:8px;font-size:.9rem}
    .dot{width:10px;height:10px;border-radius:50%;background:#6b7280}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
    .label{font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .value{font-size:1.7rem;font-weight:600;margin-top:4px}
    .zones{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px}
    .zone{display:grid;gap:8px}
    .badge{width:max-content;padding:5px 12px;border-radius:999px;font-weight:600;font-size:.8rem;color:#0f172a;background:#9aa5c4}
    .hint{text-align:center;color:var(--muted)}
    .timestamp{text-align:right;font-size:.85rem;color:var(--muted)}
    .split{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    ul{padding-left:20px;margin:0;color:var(--muted);font-size:.9rem}
    ul li{margin-bottom:6px}
  </style>
</head>
<body>
  <main>
    <header>
      <h1>SmartTraffic</h1>
      <p>Estado consolidado de zonas urbanas</p>
      <div class="status" id="conn"><span class="dot"></span><span id="conn-text">Conectando...</span></div>
    </header>
    <section class="stats">
      <div class="card"><span class="label">Zonas</span><span class="value" id="stat-total">0</span></div>
      <div class="card"><span class="label">Despejada</span><span class="value" id="stat-clear">0</span></div>
      <div class="card"><span class="label">Moderada</span><span class="value" id="stat-moderate">0</span></div>
      <div class="card"><span class="label">Congestionada</span><span class="value" id="stat-congested">0</span></div>
    </section>
    <section class="card" style="display:grid;gap:10px">
      <strong>Alertas activas</strong>
      <span id="alert-text" style="color:var(--muted)">Sin alertas, ciudad estable.</span>
    </section>
    <div class="timestamp" id="last">Esperando datos...</div>
    <section class="zones" id="zones">
      <div class="card hint">Sin eventos de Kafka por ahora.</div>
    </section>
    <section class="card" style="display:grid;gap:10px">
      <strong>Actividades recientes</strong>
      <div id="history" style="display:flex;flex-direction:column;gap:6px;color:var(--muted);font-size:.9rem">
        <span>Monitoreando cambios en tiempo real...</span>
      </div>
    </section>
  </main>
  <script>
    const conn=document.getElementById('conn'),connText=document.getElementById('conn-text'),last=document.getElementById('last'),zones=document.getElementById('zones'),alertText=document.getElementById('alert-text'),historyList=document.getElementById('history');
    const stats={total:document.getElementById('stat-total'),DESPEJADA:document.getElementById('stat-clear'),MODERADA:document.getElementById('stat-moderate'),CONGESTIONADA:document.getElementById('stat-congested')};
    const colors={DESPEJADA:'var(--ok)',MODERADA:'var(--warn)',CONGESTIONADA:'var(--alert)'};
    const history=[];
    const previousState=new Map();
    function setConn(text,color){conn.querySelector('.dot').style.background=color;connText.textContent=text;}
    function render(data){
      zones.innerHTML='';
      const entries=Object.entries(data);
      if(!entries.length){
        zones.innerHTML='<div class="card hint">Aun no hay datos.</div>';
        updateStats({total:0,DESPEJADA:0,MODERADA:0,CONGESTIONADA:0});
        updateAlerts([]);
        return;
      }
      const counts={total:entries.length,DESPEJADA:0,MODERADA:0,CONGESTIONADA:0};
      const congested=[];
      entries.sort(([a],[b])=>a.localeCompare(b)).forEach(([zone,state])=>{
        if(counts[state]!=null)counts[state]+=1;
        if(state==="CONGESTIONADA")congested.push(zone);
        const prev=previousState.get(zone);
        if(prev && prev!==state){
          history.unshift(`${new Date().toLocaleTimeString()} - ${zone}: ${prev} -> ${state}`);
          if(history.length>4)history.pop();
        }
        previousState.set(zone,state);
        const card=document.createElement('div');
        card.className='card zone';
        card.innerHTML=`<strong>${zone}</strong><span class="badge" style="background:${colors[state]||'var(--muted)'}">${state||'DESCONOCIDO'}</span>`;
        zones.appendChild(card);
      });
      updateStats(counts);
      updateAlerts(congested);
    }
    function updateStats(c){stats.total.textContent=c.total;stats.DESPEJADA.textContent=c.DESPEJADA;stats.MODERADA.textContent=c.MODERADA;stats.CONGESTIONADA.textContent=c.CONGESTIONADA;}
    function updateAlerts(congested){alertText.textContent=congested.length?`Zonas criticas: ${congested.join(", ")}. Evaluar desvios.`:"Sin alertas, ciudad estable.";}
    function updateHistory(){
      historyList.innerHTML=history.length?history.map(item=>`<span>${item}</span>`).join(""):"<span>Sin variaciones registradas.</span>";
    }
    (function connect(){
      setConn('Conectando...','#6b7280');
      const ws=new WebSocket('ws://localhost:8000/ws');
      ws.onopen=()=>setConn('Conectado','var(--ok)');
      ws.onmessage=evt=>{
        try{
          render(JSON.parse(evt.data));
          last.textContent='Ultima actualizacion: '+new Date().toLocaleTimeString();
        }catch(err){console.error(err);}
      };
      ws.onclose=()=>{
        setConn('Reconectando...','var(--warn)');
        setTimeout(connect,2000);
      };
      ws.onerror=()=>ws.close();
    })();
  </script>
</body>
</html>
